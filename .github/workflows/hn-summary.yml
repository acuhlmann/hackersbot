# Workflow to fetch and summarize Hacker News articles
# Runs daily at 11:55 PM UTC, or can be triggered manually

name: HackerNews Summary

on:
  # Daily scheduled run at end of day (11:55 PM UTC)
  schedule:
    - cron: '55 23 * * *'
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      top_n:
        description: 'Number of articles to summarize'
        required: false
        default: '5'
        type: choice
        options:
          - '3'
          - '5'
          - '10'
      filter_ai:
        description: 'Filter to AI-related articles only'
        required: false
        default: false
        type: boolean
      save_to_repo:
        description: 'Save summary to repository'
        required: false
        default: true
        type: boolean

permissions:
  contents: write  # Needed to commit summary files

jobs:
  summarize:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Determine run parameters
      id: params
      run: |
        # Use inputs if manual trigger, otherwise use defaults for scheduled runs
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "top_n=${{ github.event.inputs.top_n || '5' }}" >> $GITHUB_OUTPUT
          echo "filter_ai=${{ github.event.inputs.filter_ai || 'false' }}" >> $GITHUB_OUTPUT
          echo "save_to_repo=${{ github.event.inputs.save_to_repo || 'true' }}" >> $GITHUB_OUTPUT
        else
          # Defaults for scheduled runs
          echo "top_n=5" >> $GITHUB_OUTPUT
          echo "filter_ai=false" >> $GITHUB_OUTPUT
          echo "save_to_repo=true" >> $GITHUB_OUTPUT
        fi

    - name: Run HackerNews Summarizer
      id: summarize
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        LLM_PROVIDER: deepseek
      run: |
        # Build command
        CMD="python -m src.main --top-n ${{ steps.params.outputs.top_n }} --provider deepseek --output-format both"
        
        # Add filter flag if enabled
        if [ "${{ steps.params.outputs.filter_ai }}" == "true" ]; then
          CMD="$CMD --filter-ai"
        fi
        
        echo "Running: $CMD"
        $CMD
        
        # Get today's date for filename
        TODAY=$(date -u '+%Y-%m-%d')
        
        # Find today's output files (date-only filename format)
        LATEST_MD=$(ls outputs/${TODAY}_summary.md 2>/dev/null || ls -t outputs/*.md 2>/dev/null | head -1)
        LATEST_JSON=$(ls outputs/${TODAY}_summary.json 2>/dev/null || ls -t outputs/*.json 2>/dev/null | head -1)
        
        echo "latest_md=$LATEST_MD" >> $GITHUB_OUTPUT
        echo "latest_json=$LATEST_JSON" >> $GITHUB_OUTPUT
        echo "today=$TODAY" >> $GITHUB_OUTPUT
        
        # Copy to summaries/ directory for git tracking (outputs/ is gitignored)
        # This will replace any existing summary for today
        mkdir -p summaries
        if [ -n "$LATEST_MD" ] && [ -f "$LATEST_MD" ]; then
          # Extract just the filename and copy to summaries
          cp "$LATEST_MD" summaries/
        fi
        if [ -n "$LATEST_JSON" ] && [ -f "$LATEST_JSON" ]; then
          cp "$LATEST_JSON" summaries/
        fi

    - name: Display Summary in Job Summary
      run: |
        echo "## ðŸ“° HackerNews AI Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Articles:** ${{ steps.params.outputs.top_n }}" >> $GITHUB_STEP_SUMMARY
        echo "**AI Filter:** ${{ steps.params.outputs.filter_ai }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Append the markdown content
        if [ -f "${{ steps.summarize.outputs.latest_md }}" ]; then
          cat "${{ steps.summarize.outputs.latest_md }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "No summary file found" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Summary as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hn-summary-${{ github.run_number }}
        path: |
          outputs/*.md
          outputs/*.json
        retention-days: 30

    - name: Commit Summary to Repository
      if: steps.params.outputs.save_to_repo == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add summary files (summaries/ is tracked, outputs/ is gitignored)
        git add summaries/*.md summaries/*.json 2>/dev/null || true
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ“° HN Summary: $(date -u '+%Y-%m-%d %H:%M UTC')
          
          - Articles: ${{ steps.params.outputs.top_n }}
          - AI Filter: ${{ steps.params.outputs.filter_ai }}
          - Provider: Deepseek"
          
          git push
        fi
